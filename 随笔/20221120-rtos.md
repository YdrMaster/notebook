# RTOS 项目计划

## 项目目标

提供一个 RTOS 产品，支持国产化飞控项目运行。

### 功能需求

1. 支持多任务并发和抢占任务调度；
2. 提供功能原语
   - 动态内存分配；
   - 软件定时器（小顶堆或时间轮）；
   - 中断管理（注册、优先级控制）；
   - 同步互斥和任务间通信：
     - 互斥锁、读写锁；
     - 事件；
     - mailbox/channel；
3. 提供驱动（顺序：UART>SPI/I2C>PWM>CAN/USB>PHY）；

### 功能定义

- 实时性
  - 任务具有最坏常数的调度延迟（不在临界区执行非常数复杂度操作）；
  - 陷入具有最小的处理延迟（向量分发、分段处理）；
  - 总是执行最高优先级的任务（在每个导致优先级变化的位置重新调度，包括发生陷入、新建任务、完成或取消任务和任务优先级改变）；
  - 同优先级可以设置时间片或协作；
  - 所有需要访存的驱动使用 DMA 和协程；

### 实施情况

1. 设计
   1. 事件驱动：基于 [fast-trap](https://github.com/YdrMaster/fast-trap)，以陷入响应为中心。所有栈都是浮动的，IDLE 任务不用栈或复用一级陷入栈。
   2. 完全协程化：用户任务是协程，所有主动切换都是协程切换，当且仅当陷入产生新线程，对用户透明。
   3. 模块化：只要求 PAC 层和 HAL 的模块化，不进行自顶向下设计。
   4. 权限级别支持：仅 M 或 M+U（应该区别不大）。
2. 时间分配
   | 阶段 | 硬件 | 任务
   |-|-|-
   | 调研/实验 | qemu-system-riscv32/virt | 调研 RTOS，包括算法、性能测试方案等；尝试实现最简化的异步运行时；尝试实现独立的 PLIC 驱动；探索 DMA 抽象，尤其是同步互斥/所有权管理
   | 仿真环境开发 | qemu-system-riscv32/virt | 核心机制、用户任务接口、同步原语、串口驱动
   | 嵌入式开发 | HPM6750 开发板 | HAL、联调、硬件在环仿真
   | 生产环境移植 | HPM6750 量产板 | 试飞
   | 维护 | HPM6750 量产板 | 维护
