# 为 board-d1 外设编写驱动的工作计划和实施记录

[上周计划](20220401-summary.md)由于对现状的新的认识，已废弃。

## 现状

- 内核仅有串口驱动，尚缺 PWM、SPI、TWI（I2C）；
- 串口驱动不全，无法初始化未被 OpenSBI 操作过的 UART1-UART5；
- 串口外设抽象不支持动态开关、调整配置（尤其是波特率）、读超时、DMA；
- 成功映射任意 MMIO 设备到用户态，用户应用程序可操作外设寄存器；但这是不安全的，需要探索保证隔离性且灵活的驱动抽象；
- 现有对外设驱动的抽象有问题（或对现有抽象的定义不健全），外设种类 trait 应该是组合式的；

## 目标

1. 正确初始化串口外设，确定中断控制、时钟树配置需要在何种环境下执行；
2. 结合 GPIO 配置，使 UART5 可用；
3. 调研 UIO，研究用户态驱动的内核抽象，以及用户态驱动如何与 DMA 及中断协作；
4. 修改驱动抽象以支持下一步设计；

## 计划及实施记录

| 阶段 | 计划完成时间 | 开始时间 | 实际完成时间 | 内容 | 备注
| :-: | :-:  | :-:  | :-:  | :- | :-
|  1  |  -   | 4/1  | 4/8  | 理解现有设备树解析和中断注册过程，尝试直接映射 MMIO 外设并支持 UART5 | 上一阶段工作总结
|  2  | 4/13 | 4/8  | 4/12 | 正确初始化 UART5（时钟、FIFO、管脚复用） | 完成
|  3  | 4/15 |  -   |  -   | 调研 UIO | [重做计划](20220414-summary.md)
|  4  | 4/22 |  -   |  -   | 尝试：设计 MMIO 抽象/为 UART 支持 DMA/其他 | 待定
